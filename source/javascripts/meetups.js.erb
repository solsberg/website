(function() {
  var handler = Gmaps.build('Google'),
      mapOptions = $('meta[name=mapOptions]').attr('content');

  mapOptions = JSON.parse(mapOptions);
  mapOptions.provider.zoomControlOptions = google.maps.ZoomControlStyle.SMALL;

  handler.buildMap(mapOptions, function(){
    var markers = handler.addMarkers(<%= markers_hash.to_json %>);
    handler.bounds.extendWith(markers);
    
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(function(position){
        var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);
        handler.map.centerOn(pos);
        handler.map.serviceObject.setZoom(8);
      }, handler.fitMapToBounds.bind(handler));
    }
    else {
      handler.fitMapToBounds();
    }
  });
})();
